## 环境准备

### 系统环境准备

目前测试环境为：

- Mac OSX

### 环境准备

以下均使用 cita 测试网 https://testnet.citahub.com 来测试合约的部署和调用流程。

1. 安装 cita-cli
到网站 https://github.com/citahub/cita-cli/releases 下载安装 cita-cli。

2. 生成 account
```
./cita-cli key create > key.json
cat key.json
```
返回
```
{
  "address": "0x51b53602bf8ecaef55239fc6d3d2b20379253fb3",
  "private": "0xae469f2a07999b3ed42728b7afff2e1219441a0ef65f5e6192f2d8f0a47601b1",
  "public": "0x85e2314742a0f83144a3cd7f37885b9e5fe1957f88bf16f89cea89f3230a3f100be356babb9f9d828b0c49a100c840c5d24e7a43c9058aa1380b3ad218e7cff9"
}
```

3. 申请测试币
到网站 https://faucet.citahub.com/faucet/getNos 申请测试币

4. 查询账户余额
```
./cita-cli rpc getBalance \
--address 0x51b53602bf8ecaef55239fc6d3d2b20379253fb3 \
--url https://testnet.citahub.com
```
返回
```
{
  "id": 1,
  "jsonrpc": "2.0",
  "result": "0x65a4d9e22ee90e2b600"
}
```

### 编译合约

1. 进入到smart-audit源码文件下，然后进入到`src/cita`子目录。

2. 编译 FaceService.sol:

   ```shell
   solc oracles/face/FaceService.sol --bin
   ```
   返回:
   ```
   ======= oracles/face/FaceService.sol:FaceService =======
   Binary:
   6080604(此处略)
   ```

3. 编译 TimeService.sol:

   ```shell
   solc oracles/time/TimeService.sol --bin
   ```
   返回：
   ```
   ======= oracles/time/TimeService.sol:TimeService =======
   Binary:
   6080604(此处略)
   ```

4. 编译 IdentifyService.sol:

   ```shell
   solc oracles/identify/IdentifyService.sol --bin
   ```
   返回:
   ```
   ======= oracles/identify/IdentifyService.sol:IdentifyService =======
   Binary:
   6080604(此处略)
   ```

5. 编译 LocationService.sol:

   ```shell
   solc oracles/location/LocationService.sol --bin
   ```
   返回:
   ```
   ======= oracles/location/LocationService.sol:LocationService =======
   Binary:
   6080604(此处略)
   ```

6. 编译 audit.sol:

   ```
   ======= audit/audit.sol:Audit =======
   Binary:
   6080604(此处略)
   ```

### 部署合约

#### 部署时间合约

通过如下命令部署合约

   ```shell
   ./cita-cli rpc sendRawTransaction \
    --code 0x608060405234801561001057600080fd5b50610431806100206000396000f30060806040526004361061004c576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680632ae64bb7146100515780639fd32a3a1461008e575b600080fd5b34801561005d57600080fd5b5061007860048036036100739190810190610231565b6100b7565b604051610085919061032c565b60405180910390f35b34801561009a57600080fd5b506100b560048036036100b09190810190610272565b610107565b005b60008082511115156100fe576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016100f59061030c565b60405180910390fd5b60009050919050565b6000815111151561014d576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016101449061030c565b60405180910390fd5b5050565b600082601f830112151561016457600080fd5b813561017761017282610374565b610347565b9150818183526020840193506020810190508360005b838110156101bd57813586016101a388826101c7565b84526020840193506020830192505060018101905061018d565b5050505092915050565b600082601f83011215156101da57600080fd5b81356101ed6101e88261039c565b610347565b9150808252602083016020830185838301111561020957600080fd5b6102148382846103e8565b50505092915050565b600061022982356103d8565b905092915050565b60006020828403121561024357600080fd5b600082013567ffffffffffffffff81111561025d57600080fd5b61026984828501610151565b91505092915050565b6000806040838503121561028557600080fd5b60006102938582860161021d565b925050602083013567ffffffffffffffff8111156102b057600080fd5b6102bc85828601610151565b9150509250929050565b6000601e82527fe6b3a8e5868ce8a784e58899e68980e99c80e58f82e695b0e4b88de8b6b300006020830152604082019050919050565b610306816103c8565b82525050565b60006020820190508181036000830152610325816102c6565b9050919050565b600060208201905061034160008301846102fd565b92915050565b6000604051905081810181811067ffffffffffffffff8211171561036a57600080fd5b8060405250919050565b600067ffffffffffffffff82111561038b57600080fd5b602082029050602081019050919050565b600067ffffffffffffffff8211156103b357600080fd5b601f19601f8301169050602081019050919050565b600063ffffffff82169050919050565b600063ffffffff82169050919050565b828183376000838301525050505600a265627a7a7230582019d038118c714985c7a61074130eecc8cb35f3bec14a915f0d83f7b6da2acd146c6578706572696d656e74616cf50037 \
    --private-key 0xae469f2a07999b3ed42728b7afff2e1219441a0ef65f5e6192f2d8f0a47601b1 \
    --url https://testnet.citahub.com
   ```

   返回：
   ```shell
   {
      "id": 4,
      "jsonrpc": "2.0",
      "result": {
         "hash": "0xac63ddfd47ce752286ef110a9402f011245d9e5211bad710ee0c0e400f185b0a",
         "status": "OK"
      }
   }
   ```

   获取合约地址：
   ```
   ./cita-cli rpc getTransactionReceipt \
      --hash 0xac63ddfd47ce752286ef110a9402f011245d9e5211bad710ee0c0e400f185b0a \
      --url https://testnet.citahub.com
   ```

   得到合约地址：0x568eae6fcac7c10bfd5258730cd20b0ed90dbc60
   

#### 部署定位合约

通过如下命令部署合约

   ```shell
   ./cita-cli rpc sendRawTransaction \
      --code 0x608060405234801561001057600080fd5b50610431806100206000396000f30060806040526004361061004c576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680632ae64bb7146100515780639fd32a3a1461008e575b600080fd5b34801561005d57600080fd5b5061007860048036036100739190810190610231565b6100b7565b604051610085919061032c565b60405180910390f35b34801561009a57600080fd5b506100b560048036036100b09190810190610272565b610107565b005b60008082511115156100fe576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016100f59061030c565b60405180910390fd5b60009050919050565b6000815111151561014d576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016101449061030c565b60405180910390fd5b5050565b600082601f830112151561016457600080fd5b813561017761017282610374565b610347565b9150818183526020840193506020810190508360005b838110156101bd57813586016101a388826101c7565b84526020840193506020830192505060018101905061018d565b5050505092915050565b600082601f83011215156101da57600080fd5b81356101ed6101e88261039c565b610347565b9150808252602083016020830185838301111561020957600080fd5b6102148382846103e8565b50505092915050565b600061022982356103d8565b905092915050565b60006020828403121561024357600080fd5b600082013567ffffffffffffffff81111561025d57600080fd5b61026984828501610151565b91505092915050565b6000806040838503121561028557600080fd5b60006102938582860161021d565b925050602083013567ffffffffffffffff8111156102b057600080fd5b6102bc85828601610151565b9150509250929050565b6000601e82527fe6b3a8e5868ce8a784e58899e68980e99c80e58f82e695b0e4b88de8b6b300006020830152604082019050919050565b610306816103c8565b82525050565b60006020820190508181036000830152610325816102c6565b9050919050565b600060208201905061034160008301846102fd565b92915050565b6000604051905081810181811067ffffffffffffffff8211171561036a57600080fd5b8060405250919050565b600067ffffffffffffffff82111561038b57600080fd5b602082029050602081019050919050565b600067ffffffffffffffff8211156103b357600080fd5b601f19601f8301169050602081019050919050565b600063ffffffff82169050919050565b600063ffffffff82169050919050565b828183376000838301525050505600a265627a7a72305820f33a651b0e72d5ff19c0121cb396365acec9116500d394b377123959dfd3432d6c6578706572696d656e74616cf50037 \
      --private-key 0xae469f2a07999b3ed42728b7afff2e1219441a0ef65f5e6192f2d8f0a47601b1 \
      --url https://testnet.citahub.com
   ```

   返回：
   ```shell
   {
      "id": 4,
      "jsonrpc": "2.0",
      "result": {
         "hash": "0xe9e015f39435c49d0b6daa8b24da757a1fef25bb63fc603b7e023ee373bb3711",
         "status": "OK"
      }
   }
   ```

   获取合约地址：
   ```
   ./cita-cli rpc getTransactionReceipt \
      --hash 0xe9e015f39435c49d0b6daa8b24da757a1fef25bb63fc603b7e023ee373bb3711 \
      --url https://testnet.citahub.com
   ```

   得到合约地址：0x4254d2c7cd741ab3ff4b4c3ce97caed642be6bef

#### 部署人脸识别合约

通过如下命令部署合约

   ```shell
   ./cita-cli rpc sendRawTransaction \
    --code 0x608060405234801561001057600080fd5b50610431806100206000396000f30060806040526004361061004c576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680632ae64bb7146100515780639fd32a3a1461008e575b600080fd5b34801561005d57600080fd5b5061007860048036036100739190810190610231565b6100b7565b604051610085919061032c565b60405180910390f35b34801561009a57600080fd5b506100b560048036036100b09190810190610272565b610107565b005b60008082511115156100fe576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016100f59061030c565b60405180910390fd5b60009050919050565b6000815111151561014d576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016101449061030c565b60405180910390fd5b5050565b600082601f830112151561016457600080fd5b813561017761017282610374565b610347565b9150818183526020840193506020810190508360005b838110156101bd57813586016101a388826101c7565b84526020840193506020830192505060018101905061018d565b5050505092915050565b600082601f83011215156101da57600080fd5b81356101ed6101e88261039c565b610347565b9150808252602083016020830185838301111561020957600080fd5b6102148382846103e8565b50505092915050565b600061022982356103d8565b905092915050565b60006020828403121561024357600080fd5b600082013567ffffffffffffffff81111561025d57600080fd5b61026984828501610151565b91505092915050565b6000806040838503121561028557600080fd5b60006102938582860161021d565b925050602083013567ffffffffffffffff8111156102b057600080fd5b6102bc85828601610151565b9150509250929050565b6000601e82527fe6b3a8e5868ce8a784e58899e68980e99c80e58f82e695b0e4b88de8b6b300006020830152604082019050919050565b610306816103c8565b82525050565b60006020820190508181036000830152610325816102c6565b9050919050565b600060208201905061034160008301846102fd565b92915050565b6000604051905081810181811067ffffffffffffffff8211171561036a57600080fd5b8060405250919050565b600067ffffffffffffffff82111561038b57600080fd5b602082029050602081019050919050565b600067ffffffffffffffff8211156103b357600080fd5b601f19601f8301169050602081019050919050565b600063ffffffff82169050919050565b600063ffffffff82169050919050565b828183376000838301525050505600a265627a7a723058200b938639cb27ee211188802626294bfd0d77bfe305c3eb77d279667dd2eb9f916c6578706572696d656e74616cf50037 \
    --private-key 0xae469f2a07999b3ed42728b7afff2e1219441a0ef65f5e6192f2d8f0a47601b1 \
    --url https://testnet.citahub.com
   ```
  
   返回：
   ```
   {
      "id": 4,
      "jsonrpc": "2.0",
      "result": {
         "hash": "0x0d0faedb62523ef3bd8c6ff74da2c228ddf7dd71f0e27583a4424809b5e4f773",
         "status": "OK"
      }
   }
   ```

   查询合约地址：
   ```
   ./cita-cli rpc getTransactionReceipt \
      --hash 0x0d0faedb62523ef3bd8c6ff74da2c228ddf7dd71f0e27583a4424809b5e4f773 \
      --url https://testnet.citahub.com
   ```
   
   得到合约地址：0xfd851fbbb503cf9a0d6f0a6b5b7db073ddbc5daf

#### 部署物体识别合约

通过如下命令部署合约

   ```shell
   ./cita-cli rpc sendRawTransaction \
      --code 0x608060405234801561001057600080fd5b50610431806100206000396000f30060806040526004361061004c576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680632ae64bb7146100515780639fd32a3a1461008e575b600080fd5b34801561005d57600080fd5b5061007860048036036100739190810190610231565b6100b7565b604051610085919061032c565b60405180910390f35b34801561009a57600080fd5b506100b560048036036100b09190810190610272565b610107565b005b60008082511115156100fe576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016100f59061030c565b60405180910390fd5b60009050919050565b6000815111151561014d576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016101449061030c565b60405180910390fd5b5050565b600082601f830112151561016457600080fd5b813561017761017282610374565b610347565b9150818183526020840193506020810190508360005b838110156101bd57813586016101a388826101c7565b84526020840193506020830192505060018101905061018d565b5050505092915050565b600082601f83011215156101da57600080fd5b81356101ed6101e88261039c565b610347565b9150808252602083016020830185838301111561020957600080fd5b6102148382846103e8565b50505092915050565b600061022982356103d8565b905092915050565b60006020828403121561024357600080fd5b600082013567ffffffffffffffff81111561025d57600080fd5b61026984828501610151565b91505092915050565b6000806040838503121561028557600080fd5b60006102938582860161021d565b925050602083013567ffffffffffffffff8111156102b057600080fd5b6102bc85828601610151565b9150509250929050565b6000601e82527fe6b3a8e5868ce8a784e58899e68980e99c80e58f82e695b0e4b88de8b6b300006020830152604082019050919050565b610306816103c8565b82525050565b60006020820190508181036000830152610325816102c6565b9050919050565b600060208201905061034160008301846102fd565b92915050565b6000604051905081810181811067ffffffffffffffff8211171561036a57600080fd5b8060405250919050565b600067ffffffffffffffff82111561038b57600080fd5b602082029050602081019050919050565b600067ffffffffffffffff8211156103b357600080fd5b601f19601f8301169050602081019050919050565b600063ffffffff82169050919050565b600063ffffffff82169050919050565b828183376000838301525050505600a265627a7a72305820818617f5b35fb7295de96954b04c83411394c4b5dea4f0b894eea8372e8e27926c6578706572696d656e74616cf50037 \
      --private-key 0xae469f2a07999b3ed42728b7afff2e1219441a0ef65f5e6192f2d8f0a47601b1 \
      --url https://testnet.citahub.com
   ```

   返回：
   ```shell
   {
      "id": 4,
      "jsonrpc": "2.0",
      "result": {
         "hash": "0x71b1feaf3cf2c15e4f17112048f64421535354e9ef3169138d2459d50d25d4ad",
         "status": "OK"
      }
   }
   ```

   获取合约地址：
   ```
   ./cita-cli rpc getTransactionReceipt \
      --hash 0x71b1feaf3cf2c15e4f17112048f64421535354e9ef3169138d2459d50d25d4ad \
      --url https://testnet.citahub.com
   ```

   得到合约地址：0x47417dd1835f07a06ad93b4a262a7dd75b7cd550

#### 部署审计业务合约
   部署审计业务合约需要将上述合约地址传入作为构造参数。

   获取时间识别合约地址abi：
   ```
   ./cita-cli ethabi encode params --param address 568eae6fcac7c10bfd5258730cd20b0ed90dbc60
   ```
   返回："000000000000000000000000568eae6fcac7c10bfd5258730cd20b0ed90dbc60"

   获取定位识别合约地址abi：
   ```
   ./cita-cli ethabi encode params --param address 4254d2c7cd741ab3ff4b4c3ce97caed642be6bef
   ```
   返回："0000000000000000000000004254d2c7cd741ab3ff4b4c3ce97caed642be6bef"

   获取人脸识别合约地址abi：
   ```
   ./cita-cli ethabi encode params --param address fd851fbbb503cf9a0d6f0a6b5b7db073ddbc5daf
   ```
   返回："000000000000000000000000fd851fbbb503cf9a0d6f0a6b5b7db073ddbc5daf"

   获取物体识别合约地址abi：
   ```
   ./cita-cli ethabi encode params --param address 47417dd1835f07a06ad93b4a262a7dd75b7cd550
   ```
   返回："00000000000000000000000047417dd1835f07a06ad93b4a262a7dd75b7cd550"

将以上合约作为参数，附在审计合约后面，部署审计合约：
```

```



### 调用合约

#### 合约维护人员查询



#### 录入审计当事人



#### 录入规则



#### 录入项目



#### 新增审计事件

1. 


## 参考链接

1. [cita-cil 使用文档](https://github.com/citahub/cita-cli)
2. [solidity 官方文档](https://solidity-cn.readthedocs.io/zh/develop/index.html)

